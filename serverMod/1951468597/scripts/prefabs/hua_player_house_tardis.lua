require"prefabutil"local lqT={Asset("ANIM","anim/hua_player_house_tardis.zip")}local mP3mlD={"collapse_small","hua_floor","hua_door_exit","hua_wall","hua_house"}SetSharedLootTable('hua_player_house_tardis',{{'trinket_6',1.00},{'transistor',1.00},{'transistor',1.00},{'transistor',1.00},{'transistor',1.00},{'boards',1.00},{'boards',1.00},{'boards',1.00}})local function PrPyxMK(Hv,Ch)if Ch~=nil and Ch:HasTag("player")then end end;local function tczrIB(urkh,zhzpBSx)if zhzpBSx:HasTag("player")then elseif urkh.SoundEmitter~=nil then end end;local function a(rHSjalVy,TjhsnP)end;local function wqU76o(t5jzEd9,JZAU2)t5jzEd9.components.lootdropper:DropLoot()local zPXTTg=SpawnPrefab("collapse_big")zPXTTg.Transform:SetPosition(t5jzEd9.Transform:GetWorldPosition())zPXTTg:SetMaterial("metal")t5jzEd9:Remove()end;local function LB1Z(seMLr,qX)if not TheWorld.components.huahouse or TheWorld.components.huahouse:IsMax()then if qX and qX.builder and qX.builder.components.talker then qX.builder.components.talker:Say(STRINGS.HUAHOUSEMAX)end;return end;local h_8,xL7OTb=TheWorld.components.huahouse:GetPosition()if not(h_8 and xL7OTb)then if qX and qX.builder and qX.builder.components.talker then qX.builder.components.talker:Say(STRINGS.HUAHOUSEMAX)end;return end;local w8T3f=SpawnPrefab("hua_house")w8T3f.Transform:SetPosition(h_8,0,xL7OTb)local K=SpawnPrefab("hua_wall_decals_zhu2") K.Transform:SetPosition(h_8+0.53,0,xL7OTb-0.13)local qL=SpawnPrefab("hua_wall_decals_zhu1")qL.Transform:SetPosition(h_8-0.58,0,xL7OTb-5.63)local vfIyB=SpawnPrefab("hua_wall_decals_zhu1")vfIyB.Transform:SetPosition(h_8-0.59,0,xL7OTb+5.16)vfIyB.AnimState:SetScale(-1,1,1)vfIyB.eastside=true;local quNsijN=SpawnPrefab("hua_door_exit3")quNsijN.Transform:SetPosition(h_8+7.02,0,xL7OTb-0.18)local QUh2tc=SpawnPrefab("hua_floor")QUh2tc.Transform:SetPosition(h_8-6.8,0,xL7OTb)if QUh2tc.SetHouseWallSkin~=nil then QUh2tc.SetHouseWallSkin(QUh2tc,"hua_floorskin_tardis")end;local K=SpawnPrefab("hua_wallpaper")K.Transform:SetPosition(h_8,0,xL7OTb)if K.SetHouseWallSkin~=nil then K.SetHouseWallSkin(K,"hua_wallskin_tardis")end;quNsijN.components.hua_teleporter:Target(seMLr)seMLr.components.hua_teleporter:Target(quNsijN)local function qboV(h_8,xL7OTb)local dijn4Ph=SpawnPrefab("hua_wall")if dijn4Ph~=nil then dijn4Ph.Physics:SetCollides(false)dijn4Ph.Physics:Teleport(h_8,0,xL7OTb)dijn4Ph.Physics:SetCollides(true)end end;for CO1=-10,10 do qboV(h_8-6.8,xL7OTb+CO1)end;for RlZo=-12,11 do qboV(h_8+8.3,xL7OTb+RlZo)end;local nSBOx7=0;for SUn=-6.2,6.8 do qboV(h_8+SUn,xL7OTb-11-nSBOx7)nSBOx7=nSBOx7+0.11 end;local u=0;for Ib4=-6.2,6.8 do qboV(h_8+Ib4,xL7OTb+11+u)u=u+0.09 end;local Ki1=SpawnPrefab("hua_wall_decals_tardis")Ki1.Transform:SetPosition(h_8+7.53,0,xL7OTb-12.07)local zz1QI=SpawnPrefab("hua_wall_decals_tardis")zz1QI.Transform:SetPosition(h_8+7.53,0,xL7OTb+11.77)zz1QI.AnimState:SetScale(-1,1,1)zz1QI.eastside=true;local kFTAh=SpawnPrefab("hua_wall_decals_tardis_in") kFTAh.Transform:SetPosition(h_8-5.83,0,xL7OTb-10.34)local LBf=SpawnPrefab("hua_wall_decals_tardis_in")LBf.Transform:SetPosition(h_8-5.83,0,xL7OTb+9.77)LBf.AnimState:SetScale(-1,1,1)LBf.eastside=true;TheWorld.components.huahouse:BuildHouse()if qX and qX.builder and qX.builder.userid~=nil then seMLr._ownerid=qX.builder.userid end end;local N9L={237/255,140/255,56/255}local function hDc_M(fjV1G2,Do)if Do=="night"then fjV1G2.Light:Enable(true)else fjV1G2.Light:Enable(false)end end;local function qW0lRiD1(_,TqYJ4)if TqYJ4 =="night"then if _._window~=nil then _._window.AnimState:SetMultColour(1,1,1,1)end else if _._window~=nil then _._window.AnimState:SetMultColour(0,0,0,0)end end end;local function iD1IUx()local DI=CreateEntity("hua_player_house_tardis.MakeWindow") DI.entity:AddTransform()DI.entity:AddAnimState()DI:AddTag("DECOR")DI:AddTag("NOCLICK")DI.persists=false;DI.AnimState:SetBank("hua_player_house_tardis")DI.AnimState:SetBuild("hua_player_house_tardis")DI.AnimState:PlayAnimation("window")DI.AnimState:SetLightOverride(.4)DI.AnimState:SetBloomEffectHandle("shaders/anim.ksh")DI.AnimState:SetFinalOffset(1)DI:AddComponent("colourtweener")DI.AnimState:SetMultColour(0,0,0,0)return DI end;local function JLCOx_ak(b,E,KMw7_i1s,CQi,nHlJ)if b:HasTag("player")then b:ScreenFade(false)b:DoTaskInTime(1,function()b:SnapCamera()b:ScreenFade(true,0.5)end)end;if b.Transform~=nil then b.Transform:SetPosition(E,KMw7_i1s,CQi)end;if nHlJ then b:DoTaskInTime(0.2,function(b)if b and b:IsValid()and b:HasTag("player")and b.components.health~=nil and not b.components.health:IsDead()then b.components.health:Kill()end end)end end;local function hPQ(lw4Q7kbl,IN)IN._ownerid=lw4Q7kbl._ownerid or nil end;local function R1FIoQI(QYf1,RfsnisO)if RfsnisO and RfsnisO._ownerid~=nil then QYf1._ownerid=RfsnisO._ownerid end end;local function NsoTwDs(lvW2ga)lvW2ga.inst.name=lvW2ga.nameformat~=nil and string.format(lvW2ga.nameformat,lvW2ga.name)or lvW2ga.name;lvW2ga.inst.replica.named:SetName(lvW2ga.inst.name,"")end;local function HGli(T7RKP) if not TheNet:IsDedicated()then T7RKP._window=iD1IUx()T7RKP._window.entity:SetParent(T7RKP.entity)T7RKP.updatewindow=qW0lRiD1;T7RKP:WatchWorldState("phase",qW0lRiD1)qW0lRiD1(T7RKP,TheWorld.state.phase)T7RKP:ListenForEvent("_ta_window_alpha_dirty",function(T7RKP)local _L6Bs=T7RKP._ta_window_alpha:value()if _L6Bs<-99 then if TheWorld.state.phase~="night"then T7RKP._window.AnimState:SetMultColour(1,1,1,1)T7RKP._window.components.colourtweener:StartTween({0,0,0,0},2,function()T7RKP:updatewindow()end)end else _L6Bs=_L6Bs<0 and 0 or _L6Bs>1 and 1 or _L6Bs;T7RKP._window.AnimState:SetMultColour(_L6Bs,_L6Bs,_L6Bs,_L6Bs)T7RKP.AnimState:SetMultColour(_L6Bs,_L6Bs,_L6Bs,_L6Bs)T7RKP.Light:SetIntensity(.85*_L6Bs)end end)end end;local function iy()local SH=CreateEntity()SH.entity:AddTransform()SH.entity:AddAnimState()SH.entity:AddSoundEmitter()SH.entity:AddNetwork()SH.entity:AddLight()SH._ta_window_alpha=net_float(SH.GUID,"_ta_window_alpha","_ta_window_alpha_dirty")SH.AnimState:SetBank("hua_player_house_tardis")SH.AnimState:SetBuild("hua_player_house_tardis")SH.AnimState:PlayAnimation("idle",true)SH.Transform:SetScale(0.6,0.6,0.6)SH:AddTag("antlion_sinkhole_blocker")SH:AddTag("nonpackable")SH:AddTag("hua_house_named")SH:AddTag("_named")MakeObstaclePhysics(SH,0.7)MakeSnowCoveredPristine(SH)SH.Light:SetFalloff(.5)SH.Light:SetIntensity(.85)SH.Light:SetRadius(1.2)SH.Light:SetColour(unpack(N9L))HGli(SH)SH.entity:SetPristine()if not TheWorld.ismastersim then return SH end;SH:RemoveTag("_named")SH:AddComponent("inspectable")SH.components.inspectable.nameoverride="HUA_PLAYER_HOUSE_TARDIS"SH.components.inspectable.getspecialdescription=function()return STRINGS.CHARACTERS.GENERIC.DESCRIBE.HUA_PLAYER_HOUSE_TARDIS_TELEPORTING end;SH:AddComponent("named")SH.components.named.housename=nil;SH.components.named.OnSave=function(wU4wYbA9)return wU4wYbA9.housename~=nil and{housename=wU4wYbA9.housename,nameformat=wU4wYbA9.nameformat}or nil end;SH.components.named.OnLoad=function(fFeQcIM,JEHSHPh3)if JEHSHPh3 ~=nil and JEHSHPh3.housename~=nil then fFeQcIM.nameformat=JEHSHPh3.nameformat;fFeQcIM.name=JEHSHPh3.housename;fFeQcIM.housename=JEHSHPh3.housename;NsoTwDs(fFeQcIM)end end;SH:ListenForEvent("onbuilt",LB1Z)MakeSnowCovered(SH)hDc_M(SH,TheWorld.state.phase)return SH end;local function m6SCS0()local bb=CreateEntity()bb.entity:AddTransform()bb.entity:AddAnimState()bb.entity:AddSoundEmitter()bb.entity:AddMiniMapEntity()bb.entity:AddNetwork()bb.entity:AddLight()bb._ta_window_alpha=net_float(bb.GUID,"_ta_window_alpha","_ta_window_alpha_dirty")bb.MiniMapEntity:SetIcon("hua_player_house_tardis.tex")bb.AnimState:SetBank("hua_player_house_tardis")bb.AnimState:SetBuild("hua_player_house_tardis")bb.AnimState:PlayAnimation("idle",true)bb.Transform:SetScale(0.6,0.6,0.6)bb:AddTag("hua_door")bb:AddTag("shelter")bb:AddTag("antlion_sinkhole_blocker")bb:AddTag("nonpackable")bb:AddTag("hua_house_named")bb:AddTag("_named")MakeObstaclePhysics(bb,0.7)MakeSnowCoveredPristine(bb)bb.Light:SetFalloff(.5) bb.Light:SetIntensity(.85)bb.Light:SetRadius(1.2)bb.Light:SetColour(unpack(N9L))HGli(bb)bb.entity:SetPristine()if not TheWorld.ismastersim then return bb end;bb:RemoveTag("_named")bb:AddComponent("inspectable")bb:AddComponent("named")bb.components.named.housename=nil;bb.components.named.OnSave=function(o5e6fP)return o5e6fP.housename~=nil and{housename=o5e6fP.housename,nameformat=o5e6fP.nameformat}or nil end;bb.components.named.OnLoad=function(iq7ol,eMV)if eMV~=nil and eMV.housename~=nil then iq7ol.nameformat=eMV.nameformat;iq7ol.name=eMV.housename;iq7ol.housename=eMV.housename;NsoTwDs(iq7ol)end end;bb:AddComponent("hua_teleporter")bb.components.hua_teleporter.onActivate=tczrIB;bb.components.hua_teleporter.offset=0;bb.components.hua_teleporter.travelcameratime=1;bb.components.hua_teleporter.travelarrivetime=0.5;bb:ListenForEvent("doneteleporting",PrPyxMK)bb:AddComponent("lootdropper")bb.components.lootdropper:SetChanceLootTable("hua_player_house_tardis")if TUNING.HUA_HOUSE_HAMMER==true then bb:AddComponent("workable")bb.components.workable:SetWorkAction(ACTIONS.HAMMER)bb.components.workable:SetWorkLeft(5)bb.components.workable:SetOnFinishCallback(wqU76o)bb.components.workable:SetOnWorkCallback(a)end;bb:ListenForEvent("onbuilt",LB1Z)MakeSnowCovered(bb)bb:WatchWorldState("phase",hDc_M)hDc_M(bb,TheWorld.state.phase)bb:ListenForEvent("onremove",function(bb) local WDTNkTD,Oejsws,CkD73N0=bb.Transform:GetWorldPosition()if not WDTNkTD then for PlwhaRKJ,Caz4NM4Z in pairs(Ents)do if Caz4NM4Z:HasTag("multiplayer_portal")then WDTNkTD,Oejsws,CkD73N0=Caz4NM4Z.Transform:GetWorldPosition()end end end;if not WDTNkTD then WDTNkTD,Oejsws,CkD73N0=0,0,0 end;if bb.components.hua_teleporter and bb.components.hua_teleporter.targetTeleporter~=nil then local XVxxx=bb.components.hua_teleporter.targetTeleporter;local hD,G5BuU5,AfwsY=XVxxx.Transform:GetWorldPosition()local T=TheSim:FindEntities(hD,0,AfwsY,20,nil,{"INLIMBO"})for WZs,ITdz in ipairs(T)do if ITdz:HasTag("player")or ITdz:HasTag("irreplaceable")or ITdz.components.health~=nil then JLCOx_ak(ITdz,WDTNkTD,Oejsws,CkD73N0,true)elseif ITdz.components.workable~=nil then ITdz.components.workable:Destroy(ITdz)elseif ITdz.components.perishable~=nil then ITdz.components.perishable:LongUpdate(10000)elseif ITdz.components.finiteuses~=nil then ITdz.components.finiteuses:Use(10000)elseif ITdz.components.fueled~=nil then ITdz.components.fueled:DoUpdate(10000)end end TheWorld:DoTaskInTime(0.5,function(AjfoUo)local Er9zidsB=TheSim:FindEntities(hD,0,AfwsY,20)for X,dR in ipairs(Er9zidsB)do if dR and dR.components.inventoryitem~=nil then JLCOx_ak(dR,WDTNkTD,Oejsws,CkD73N0)else dR:Remove()end end end)end end)bb.OnSave=hPQ bb.OnLoad=R1FIoQI;return bb end;local function NUhYw6R4(JFXtQwy)JFXtQwy.Transform:SetScale(0.6,0.6,0.6)end;return Prefab("hua_player_house_tardis",m6SCS0,lqT,mP3mlD),Prefab("hua_player_house_tardis_fake",iy,lqT,mP3mlD),MakePlacer("hua_player_house_tardis_placer","hua_player_house_tardis","hua_player_house_tardis","idle",nil,nil,nil,nil,nil,nil,NUhYw6R4)