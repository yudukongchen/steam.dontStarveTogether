local Vu0cCAf=require"widgets/widget"local q=require"widgets/image"local kP7O5=require"widgets/screen"local lqT=require"widgets/button"local mP3mlD=require"widgets/text"local PrPyxMK=require"widgets/uianim"local tczrIB=require"widgets/textbutton"local a=require"widgets/imagebutton"local function wqU76o(R1FIoQI,NsoTwDs,HGli)if type(R1FIoQI)=='table'then R1FIoQI,NsoTwDs,HGli=R1FIoQI:Get()end;return Vector3(R1FIoQI,0,NsoTwDs)end;local function LB1Z(iy,m6SCS0,NUhYw6R4)if type(iy)=='table'then iy,m6SCS0,NUhYw6R4=iy:Get()end;return Vector3(iy,NUhYw6R4,0)end local N9L=Class(Vu0cCAf,function(Hv)Vu0cCAf._ctor(Hv,"handler")local Ch=1.05;Hv.img=Hv:AddChild(a("images/hud/tardis_ui.xml","tardis_handler_off.tex"))Hv.img.focus_scale={Ch,Ch,Ch}Hv.img.onclick=function()if Hv.main:CanActivate()then Hv.img:SetTextures("images/hud/tardis_ui.xml","tardis_handler_on.tex")Hv.img:SetPosition(-18,-28)Hv.img:Disable()Hv.main:Active()else Hv.main:PushLog("Please point a destination!")end end;Hv.Reset=function(Hv)Hv.img:SetTextures("images/hud/tardis_ui.xml","tardis_handler_off.tex")Hv.img:SetPosition(0,0)Hv.img:Enable()end end)local hDc_M,qW0lRiD1=0,0;local iD1IUx=4 local JLCOx_ak=Class(kP7O5,function(urkh,zhzpBSx)kP7O5._ctor(urkh,"MapWidget")urkh.owner=ThePlayer;urkh.minimap=TheWorld.minimap.MiniMap;urkh.house_pos=Vector3(ThePlayer._ta_center_x:value(),0,ThePlayer._ta_center_y:value())urkh.last_press_pos=nil;urkh.is_click=nil;urkh.repeat_time=0;local rHSjalVy=urkh:AddChild(Vu0cCAf("root"))rHSjalVy:SetHAnchor(ANCHOR_MIDDLE)rHSjalVy:SetVAnchor(ANCHOR_MIDDLE)rHSjalVy:SetScaleMode(SCALEMODE_PROPORTIONAL)local TjhsnP=rHSjalVy:AddChild(q("images/hud/tardis_ui.xml","tardis_screen_frame.tex"))TjhsnP:SetTint(0,0,0,0)TjhsnP:SetSize(860,500)TjhsnP:SetPosition(3,0)urkh.frame_click=TjhsnP;local t5jzEd9=rHSjalVy:AddChild(q("images/hud/tardis_ui.xml","tardis_screen_bg.tex"))t5jzEd9.inst.ImageWidget:SetBlendMode(BLENDMODE.Premultiplied)t5jzEd9:SetClickable(true)t5jzEd9:SetSize(640,400)t5jzEd9:SetPosition(hDc_M,qW0lRiD1)t5jzEd9:SetVRegPoint(ANCHOR_MIDDLE)t5jzEd9:SetHRegPoint(ANCHOR_MIDDLE)urkh.bg=t5jzEd9;local JZAU2=t5jzEd9:AddChild(Vu0cCAf("scissor"))JZAU2:SetScissor(-320,-200,640,400)local zPXTTg=JZAU2:AddChild(q())zPXTTg.inst.ImageWidget:SetBlendMode(BLENDMODE.Additive)zPXTTg.inst.ImageWidget:SetTextureHandle(urkh.minimap:GetTextureHandle())zPXTTg:SetClickable(false)urkh.map=zPXTTg;local seMLr=rHSjalVy:AddChild(q("images/hud/tardis_ui.xml",'tardis_screen_frame.tex'))seMLr:SetClickable(false)seMLr:SetSize(860,500)seMLr:SetPosition(3,0)urkh.frame=seMLr;local qX={0.2,0.7,1,0.5}local h_8=t5jzEd9:AddChild(mP3mlD(NUMBERFONT,30,''))h_8:SetPosition(360,110)h_8:SetColour(unpack(qX))h_8:SetRegionSize(250,150)h_8:SetHAlign(ANCHOR_LEFT)h_8:SetVAlign(ANCHOR_TOP)urkh.coord=h_8 local xL7OTb=t5jzEd9:AddChild(Vu0cCAf("log_root"))xL7OTb:SetPosition(-150,-200)for qL=1,iD1IUx do local vfIyB=xL7OTb:AddChild(mP3mlD(NUMBERFONT,30,''))vfIyB:SetPosition(0,30*qL)vfIyB:SetColour(unpack(qX))vfIyB:SetRegionSize(300,50)vfIyB:SetHAlign(ANCHOR_LEFT)xL7OTb[qL]=vfIyB end;urkh.log_root=xL7OTb;local w8T3f=rHSjalVy:AddChild(N9L())w8T3f:SetPosition(450,-200)w8T3f.main=urkh;urkh.jumpbt=w8T3f;local K=zPXTTg:AddChild(PrPyxMK())K:GetAnimState():SetBank("tardis_pointer")K:GetAnimState():SetBuild("tardis_pointer")K:GetAnimState():PlayAnimation("idle",true)K:SetScale(0.6)K:Hide()K.Bloom=function(urkh)urkh:GetAnimState():Pause()local quNsijN=0;if not urkh.btask then urkh.btask=urkh.inst:DoPeriodicTask(0,function(QUh2tc)quNsijN=quNsijN+1;QUh2tc.AnimState:SetMultColour(0.4,0.9,1,Remap(quNsijN,1,15,1,0))urkh:SetScale(Remap(quNsijN,1,15,0.6,1.5))if quNsijN==15 then urkh.btask:Cancel()urkh.btask=nil;QUh2tc.AnimState:Resume()end end)end end;urkh.targetui=K;urkh:OnShow()urkh:FocusPos(urkh.house_pos)end)function JLCOx_ak:FocusPos(qboV)self.minimap:ResetOffset()local nSBOx7=self:WorldPosToMousePos(qboV)*-0.223;self:Offset(nSBOx7:Get())end;function JLCOx_ak:MapPosToWidgetPos(u,K,i1)local zz1QI=type(u)=='table'and u or Vector3(u,K,i1)local kFTAh,LBf=TheSim:GetScreenSize()local dijn4Ph=1;return Vector3(zz1QI.x*kFTAh/2*dijn4Ph,zz1QI.y*LBf/2*dijn4Ph,0)end;function JLCOx_ak:WorldPosToMapPos(CO1,RlZo,SUn)return self.minimap:WorldPosToMapPos(CO1,RlZo,SUn)end;function JLCOx_ak:MapPosToWorldPos(Ib4,fjV1G2,Do)return self.minimap:MapPosToWorldPos(Ib4,fjV1G2,Do)end;function JLCOx_ak:ScreenPosToWidgetPos(_)local TqYJ4,DI=TheSim:GetScreenSize()return Vector3(_.x-TqYJ4/2-hDc_M,_.y-DI/2-qW0lRiD1,0)end;function JLCOx_ak:WidgetPosToMapPos(b)local E,KMw7_i1s=TheSim:GetScreenSize()local CQi=1/self.map:GetScale().x;return Vector3(b.x*2/E*CQi,b.y*2/KMw7_i1s*CQi,0)end;function JLCOx_ak:MousePosToWorldPos()local nHlJ=TheInput:GetScreenPosition()local lw4Q7kbl=self:ScreenPosToWidgetPos(nHlJ)local IN=self:WidgetPosToMapPos(lw4Q7kbl)local QYf1,RfsnisO,lvW2ga=self:MapPosToWorldPos(IN:Get())return Vector3(QYf1,0,RfsnisO)end;function JLCOx_ak:WorldPosToMousePos(T7RKP)local _L6Bs,SH,wU4wYbA9=self:WorldPosToMapPos(LB1Z(T7RKP):Get())local fFeQcIM=self:MapPosToWidgetPos(_L6Bs,SH,wU4wYbA9)return fFeQcIM end;function JLCOx_ak:OnZoomIn()if self.shown then self.minimap:Zoom(-1)self:UpdateTargetUI()end end;function JLCOx_ak:OnZoomOut() if self.shown and self.minimap:GetZoom()<20 then self.minimap:Zoom(1)self:UpdateTargetUI()end end;function JLCOx_ak:Offset(JEHSHPh3,bb)self.minimap:Offset(JEHSHPh3,bb)end;function JLCOx_ak:OnShow()self.minimap:ResetOffset()if not self.minimap:IsVisible()then self.minimap:ToggleVisibility()end end;function JLCOx_ak:OnHide()if self.minimap:IsVisible()then self.minimap:ToggleVisibility()end;self.lastpos=nil end;function JLCOx_ak:OnControl(o5e6fP,iq7ol)if JLCOx_ak._base.OnControl(self,o5e6fP,iq7ol)then return true end;if self.teleport_time~=nil then return true end;if not iq7ol and o5e6fP==CONTROL_CANCEL then self:Hide()TheFrontEnd:PopScreen()return true end;if o5e6fP==CONTROL_MAP_ZOOM_IN then self:OnZoomIn()self.repeat_time=.025 elseif o5e6fP==CONTROL_MAP_ZOOM_OUT then self:OnZoomOut()self.repeat_time=.025 elseif o5e6fP==CONTROL_ACCEPT and not self.bg.focus and not self.frame_click.focus and not iq7ol then self:Hide()TheFrontEnd:PopScreen()else return false end;return true end function JLCOx_ak:OnUpdate(eMV)if not self.shown then return end;local WDTNkTD=TheInput:GetScreenPosition()if self.teleport_time==nil then if self.repeat_time<=0 then if TheInput:IsControlPressed(CONTROL_MAP_ZOOM_IN)then self:OnZoomIn()elseif TheInput:IsControlPressed(CONTROL_MAP_ZOOM_OUT)then self:OnZoomOut()end;self.repeat_time=.025 else self.repeat_time=self.repeat_time-eMV end;if TheInput:IsControlPressed(CONTROL_PRIMARY)then if self.lastpos then local Oejsws=0.25 local CkD73N0=Oejsws* (WDTNkTD.x-self.lastpos.x)local PlwhaRKJ=Oejsws* (WDTNkTD.y-self.lastpos.y)self.minimap:Offset(CkD73N0,PlwhaRKJ)end;self.lastpos=WDTNkTD;if self.last_press_pos==nil and self.bg.focus then self.last_press_pos=WDTNkTD;self.is_click=true else if self.is_click and self.last_press_pos:DistSq(WDTNkTD)>4*4 then self.is_click=false end end else self.lastpos=nil;self.last_press_pos=nil;if self.is_click then self:SetTargetUIPos()self.is_click=false end end else self.teleport_time=self.teleport_time+eMV;self.targetui:GetAnimState():SetDeltaTimeMultiplier(Remap(self.teleport_time,0,9,1,3))end;self:UpdateTargetUI()if self.bg.focus then local Caz4NM4Z,XVxxx=self:ScreenPosToWidgetPos(WDTNkTD):Get()self.coord:SetString(string.format("x: %4.1d\ny: %4.1d",Caz4NM4Z,XVxxx))end end;function JLCOx_ak:UpdateTargetUI()if self.targetui.shown and self.target_pos~=nil then local hD=self:WorldPosToMousePos(self.target_pos)self.targetui:SetPosition(hD)if self.teleport_time==nil then local G5BuU5=self.minimap:GetZoom()local AfwsY=Remap(G5BuU5,0,20,0.6,0.2)self.targetui:SetScale(AfwsY)end end end;local function hPQ(T)local WZs,ITdz,AjfoUo=T:Get()return TheWorld.Map:IsVisualGroundAtPoint(WZs,ITdz,AjfoUo)and TheWorld.Map:GetTileAtPoint(WZs,ITdz,AjfoUo)~=GROUND.INVALID end;function JLCOx_ak:SetTargetUIPos()if not self.bg.focus then return end;local Er9zidsB=self:MousePosToWorldPos()self.targetui:Show()self.target_pos=Er9zidsB;if hPQ(Er9zidsB)then self.targetui:GetAnimState():SetMultColour(0.4,0.9,1,1)self:PushLog(string.format("teleporter.SetTarget(%.2f, %.2f)",Er9zidsB.x,Er9zidsB.z))else self.targetui:GetAnimState():SetMultColour(1,0.3,0.3,1)self:PushLog("ValueError: Invalid coordinate.")end end;function JLCOx_ak:CanActivate()if not self.target_pos then return false end;if not hPQ(self.target_pos)then return false end;return true end function JLCOx_ak:Active() SendModRPCToServer(MOD_RPC["huahouse_name"]["ta_teleport"],self.target_pos.x,self.target_pos.z)self.teleport_time=0;self.inst:DoTaskInTime(0,function()self:PushLog("door.Lock(10000)")end)self.inst:DoTaskInTime(0.4,function()self:PushLog(string.format("gui.Focus(%.2f, %.2f)",self.target_pos.x,self.target_pos.z))self.targetui:SetScale(0.6)self.minimap:Zoom(-20)self:FocusPos(self.target_pos)end)self.inst:DoTaskInTime(1.3,function()self:PushLog("teleporter.Activate()")end)self.inst:DoTaskInTime(2.0,function()self:PushLog("teleporter.JumpIn()")end)for X=4,9,0.5 do self.inst:DoTaskInTime(X,function()self:PushLog(">",X>4)end)end;self.inst:DoTaskInTime(10.0,function()self:PushLog("teleporter.JumpOut()")self.targetui:Bloom()end)self.inst:DoTaskInTime(11.0,function()self:PushLog("system.SelfCheck()")end)self.inst:DoTaskInTime(11.5,function()self:PushLog("0")end)self.inst:DoTaskInTime(12.0,function()self.jumpbt:Reset()self.teleport_time=nil;self.target_pos=nil;self.targetui:GetAnimState():SetDeltaTimeMultiplier(1)end)end;function JLCOx_ak:PushLog(dR,JFXtQwy)if type(dR)~="string"then return end;if JFXtQwy then self.log_root[1]:SetString(self.log_root[1]:GetString()..dR)else for uMV17h0=iD1IUx,2,-1 do self.log_root[uMV17h0]:SetString(self.log_root[uMV17h0-1]:GetString())end;self.log_root[1]:SetString(dR)end end;return JLCOx_ak